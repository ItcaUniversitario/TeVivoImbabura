<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TE VIVO IMBABURA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #2c2c2c;
        height: 100vh;
        position: relative;
        overflow: hidden;
    }

    body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background-image: url('assets/imbaburafondo.png');
        background-size: cover;
        background-position: center;
        filter: blur(10px) brightness(1);
        transform: scale(1.05);
    }

    .dashboard-container {
        width: 100%;
        height: 100%;
        background-color: transparent;
        display: flex;
        flex-direction: column;
    }

    header {
        background-image: url('assets/banner_tvi.png');
        background-repeat: no-repeat;
        background-position: center;
        height: 50px;
        background-size: 50% auto;
        padding: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 10px 0;
        position: relative;
        z-index: 100;
    }

    header .settings-button {
        position: absolute;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
    }

    header .settings-button svg {
        fill: #FFFFFF;
        width: 40px;
        height: 40px;
    }

    header .settings-button:hover svg {
        fill: #090909;
    }
    
    header .settings-button:hover {
        background-color: transparent !important;
    }
    
    header .settings-button:focus {
        outline: none;
        box-shadow: none;
    }

    /* Botón de Info alineado */
    #game-info-button {
        position: absolute;
        top: 50%;
        right: 70px;
        transform: translateY(-50%);
    }

    main {
        flex-grow: 1;
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    /* Sistema de Pantallas */
    .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: white;
    }

    .screen.active {
        opacity: 1;
        pointer-events: auto;
    }

    #video-screen {
        background-color: black;
    }

    #local-video-player {
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 5;
        object-fit: cover;
    }

    /* --- CAMBIO 1: EL MAPA AL 80% Y CENTRADO --- */
    #map-screen {
        padding: 0;
        position: relative;
        background-color: #2e7d32;
        /* Centramos el contenedor del mapa */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #map-zoom-container {
        position: relative;
        /* Aquí definimos que ocupe el 80% del espacio disponible */
        width: 80%;
        height: 80%;
        
        /* Eliminamos todas las transformaciones de zoom */
        transform: none !important;
        transition: none !important;
        transform-origin: center center !important;
        
        /* Opcional: Sombra para que resalte sobre el fondo */
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        background-color: #2e7d32;
    }

    #map-image {
        width: 100%;
        height: 100%;
        /* Fill asegura que la imagen llene el 80% exacto para que las coordenadas funcionen */
        object-fit: fill; 
    }

    /* --- CAMBIO 2: LA FICHA (Sin zoom) --- */
    .player-ficha-class {
        position: absolute;
        width: 50px;  /* Tamaño fijo */
        height: 50px; /* Tamaño fijo */
        border-radius: 50%;
        z-index: 40;
        display: none;

        /* Solo centramos la ficha en su punto */
        transform: translate(-50%, -50%);

        transition: top 0.6s linear, left 0.6s linear; 
        will-change: top, left;

        background-size: 80%;
        background-repeat: no-repeat;
        background-position: center;
        background-color: transparent;
    }

    .player-ficha-class.active-turn {
        box-shadow: 0 0 15px 5px #33AFFF;
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* --- ELIMINADO: Reglas de zoom loader y scale --- */

    /* MODAL REGISTRO */
    #registration-modal-backdrop {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 1000; display: none; justify-content: flex-end; align-items: center;
        padding: 20px; box-sizing: border-box; background-color: transparent;
    }
    #registration-modal::before {
        content: ""; position: absolute; z-index: -1; inset: -0px;
        background-image: url('assets/portada_cati_tvi.png');
        background-size: cover; background-repeat: no-repeat; background-position: center bottom;
    }
    #registration-modal h2 {
        margin-top: 0; margin-bottom: 10px; text-align: center; color: white;
        font-size: 1.3em; font-weight: 600; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
    }
    #registration-modal label {
        display: block; margin-bottom: 3px; font-weight: 600; font-size: 0.8em;
        color: #ffffff; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
    }
    #registration-modal input, #registration-modal select {
        width: 80%; padding: 6px 10px; margin-bottom: 8px; border: 1px solid #E0E0E0;
        border-radius: 6px; box-sizing: border-box; background-color: #F7F9F5;
        font-size: 0.9em; transition: border-color 0.3s, box-shadow 0.3s;
    }
    #registration-modal input:focus, #registration-modal select:focus {
        border-color: #8BC34A; box-shadow: 0 0 0 2px rgba(139, 195, 74, 0.2);
        outline: none; background-color: #fff;
    }
    #registration-modal button {
        width: 80%; padding: 8px; border: none; border-radius: 6px;
        background-color: #8BC34A; color: white; font-size: 1em; font-weight: bold;
        cursor: pointer; margin-top: 5px; transition: background-color 0.3s, transform 0.2s;
    }
    #registration-modal button:hover:not(:disabled) { background-color: #7CB342; }
    #registration-modal button:disabled { background-color: #C5E1A5; cursor: not-allowed; }
    .modal-header {
        display: flex; justify-content: space-between; align-items: center;
        width: 100%; margin-bottom: 15px;
    }
    #registration-modal .modal-header h2 { margin: 0; flex-grow: 1; text-align: left; }

    .settings-button {
        display: inline-block; padding: 5px; line-height: 0; text-decoration: none;
        border-radius: 50%; transition: background-color 0.3s;
    }
    .settings-button svg { width: 22px; height: 22px; fill: #070707; transition: fill 0.3s; }
    .settings-button:hover { background-color: #e9e9e9; }
    .settings-button:hover svg { fill: #060606; }

    /* DADO */
    #dice-container {
        position: absolute; bottom: 20px; left: 20px; display: flex;
        flex-direction: column; align-items: center; background-color: transparent;
        z-index: 50; perspective: 800px; transition: transform 0.2s ease, z-index 0s 1s;
    }
    .dice-scene {
        width: 70px; height: 70px; cursor: pointer;
        transition: transform 0.2s ease; transform-style: preserve-3d;
    }
    .dice-cube {
        width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
        transform: translateZ(-35px); transition: transform 1.5s ease-out;
    }
    .dice-cube .dice-face {
        position: absolute; width: 70px; height: 70px; box-sizing: border-box;
        background-color: #fff; border-radius: 8px; border: 1px solid #333;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1); display: flex;
        justify-content: center; align-items: center; backface-visibility: hidden; padding: 10px;
    }
    #face-1 { transform: rotateY(0deg) translateZ(35px); }
    #face-6 { transform: rotateY(180deg) translateZ(35px); }
    #face-4 { transform: rotateY(90deg) translateZ(35px); }
    #face-3 { transform: rotateY(-90deg) translateZ(35px); }
    #face-2 { transform: rotateX(90deg) translateZ(35px); }
    #face-5 { transform: rotateX(-90deg) translateZ(35px); }

    .pip {
        display: block; position: absolute; width: 10px; height: 10px;
        background-color: #4CAF50; border-radius: 50%;
    }
    #face-1 .pip { top: 50%; left: 50%; transform: translate(-50%, -50%); }
    #face-2 .pip.tl { top: 10px; left: 10px; }
    #face-2 .pip.br { bottom: 10px; right: 10px; }
    #face-3 .pip.tl { top: 10px; left: 10px; }
    #face-3 .pip.c { top: 50%; left: 50%; transform: translate(-50%, -50%); }
    #face-3 .pip.br { bottom: 10px; right: 10px; }
    #face-4 .pip.tl { top: 10px; left: 10px; }
    #face-4 .pip.tr { top: 10px; right: 10px; }
    #face-4 .pip.bl { bottom: 10px; left: 10px; }
    #face-4 .pip.br { bottom: 10px; right: 10px; }
    #face-5 .pip.tl { top: 10px; left: 10px; }
    #face-5 .pip.tr { top: 10px; right: 10px; }
    #face-5 .pip.c { top: 50%; left: 50%; transform: translate(-50%, -50%); }
    #face-5 .pip.bl { bottom: 10px; left: 10px; }
    #face-5 .pip.br { bottom: 10px; right: 10px; }
    #face-6 .pip.tl { top: 10px; left: 10px; }
    #face-6 .pip.tr { top: 10px; right: 10px; }
    #face-6 .pip.cl { top: 50%; left: 10px; transform: translateY(-50%); }
    #face-6 .pip.cr { top: 50%; right: 10px; transform: translateY(-50%); }
    #face-6 .pip.bl { bottom: 10px; left: 10px; }
    #face-6 .pip.br { bottom: 10px; right: 10px; }

    @keyframes roll-animation {
        0% { transform: translateZ(-35px) rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
        100% { transform: translateZ(-35px) rotateX(1080deg) rotateY(720deg) rotateZ(1440deg); }
    }
    .dice-cube.is-rolling { animation: roll-animation 1.5s linear; }
    .dice-cube.show-1 { transform: translateZ(-35px) rotateY(0deg); }
    .dice-cube.show-6 { transform: translateZ(-35px) rotateY(-180deg); }
    .dice-cube.show-4 { transform: translateZ(-35px) rotateY(-90deg); }
    .dice-cube.show-3 { transform: translateZ(-35px) rotateY(90deg); }
    .dice-cube.show-2 { transform: translateZ(-35px) rotateX(-90deg); }
    .dice-cube.show-5 { transform: translateZ(-35px) rotateX(90deg); }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        50% { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7); }
        100% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    }
    .dice-ready { animation: pulse 2s infinite; }

    .turn-indicator {
        background-color: rgba(0, 0, 0, 0.75); color: white; padding: 8px 15px;
        border-radius: 20px; font-size: 1.1em; font-weight: bold; font-family: 'Lora', serif;
        margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); opacity: 0;
        display: none; transition: opacity 0.3s ease; animation: pulse 2s infinite;
    }
    .turn-indicator.visible { display: block; opacity: 1; }
    #turn-indicator-name { color: #8bc34a; text-transform: uppercase; }

    /* MODALES GENERALES */
    .modal-backdrop {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7); z-index: 3000; display: none;
        justify-content: center; align-items: center; opacity: 0; transition: opacity 0.4s ease;
    }
    .modal-content {
        background-color: white; padding: 25px 35px; border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); text-align: center; width: 90%;
        max-width: 450px; transform: scale(0.9); transition: transform 0.4s ease;
        max-height: 90%; overflow-y: auto; box-sizing: border-box;
    }
    .modal-backdrop.visible { opacity: 1; }
    .modal-backdrop.visible .modal-content { transform: scale(1); }
    .modal-content h2 { color: #055513; font-size: 1.6em; margin-top: 0; margin-bottom: 15px; }
    #info-modal-image {
        max-width: 80%; display: block; margin-left: auto; margin-right: auto;
        height: auto; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .modal-content p {
        font-size: 1.1em; color: #333; line-height: 1.6; margin-bottom: 25px;
    }
    #event-icon-container { width: 50px; height: auto; margin: 20px auto; }
    #event-icon-container svg { fill: #FFC107; }
    .modal-content button {
        padding: 10px 25px; background-color: #8bc34a; color: white; border: none;
        border-radius: 7px; font-size: 1em; cursor: pointer; transition: background-color 0.3s ease;
    }
    .modal-content button:hover { background-color: #7cb342; }

    #question-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .option-button {
        width: 100%; padding: 12px; font-size: 1em; border: 2px solid #ddd;
        border-radius: 8px; background-color: #f8f8f8; cursor: pointer; transition: all 0.2s ease;
    }
    .option-button:hover:not(:disabled) { background-color: #e9e9e9; border-color: #a7c7e7; }
    .option-button.correct { background-color: #c8e6c9; border-color: #4caf50; color: #2e7d32; font-weight: bold; }
    .option-button.incorrect { background-color: #ffcdd2; border-color: #f44336; color: #c62828; font-weight: bold; }
    #question-feedback { min-height: 20px; font-weight: bold; font-size: 1.1em; margin-bottom: 20px; }

    #player-stats-container {
        position: absolute; top: 10px; left: 10px; z-index: 50;
        background-color: rgba(255, 255, 255, 0.92); border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); padding: 10px; display: flex;
        flex-direction: column; gap: 8px; width: 310px; max-width: calc(100vw - 20px);
        box-sizing: border-box; transition: all 0.3s ease;
    }
    .player-stat-row {
        display: grid; grid-template-columns: auto 1fr auto; grid-template-rows: auto auto;
        align-items: center; padding: 5px; border-radius: 8px; border: 2px solid transparent;
        transition: all 0.3s ease; background-color: rgba(240, 240, 240, 0.5);
    }
    .player-stat-row.active-turn {
        border-color: #0074D9; background-color: #ffffff; box-shadow: 0 2px 8px rgba(0, 116, 217, 0.3);
    }
    .player-stat-row .player-name {
        grid-column: 2 / 3; grid-row: 1 / 2; font-size: 1.1em; font-weight: bold;
        font-family: 'Lora', serif; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .player-stat-row .player-score {
        grid-column: 3 / 4; grid-row: 1 / 3; font-size: 1.6em; font-weight: 700;
        color: #0074D9; padding-left: 5px; text-align: right; align-self: center;
    }
    .player-stat-row .player-inventory-small {
        grid-column: 2 / 3; grid-row: 2 / 3; display: grid;
        grid-template-columns: repeat(5, 1fr); gap: 4px; min-height: 22px;
    }
    .player-stat-row .player-ficha-icon {
        grid-column: 1 / 2; grid-row: 1 / 3; width: 28px; height: 28px;
        object-fit: contain; border-radius: 50%; background-color: #e9e9e9;
        border: 1px solid #ccc; margin-right: 8px; align-self: center; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        #player-stats-container { width: auto; padding: 8px; }
        .player-stat-row .player-name { font-size: 1em; }
        .player-stat-row .player-score { font-size: 1.4em; }
        .player-inventory-small .small-reward-icon { width: 18px; height: 18px; }
        .player-stat-row .player-ficha-icon { width: 28px; height: 28px; }
        .reward-slot { width: 22px; height: 22px; }
        .reward-slot-counter { font-size: 11px; }
    }

    .reward-slot { position: relative; width: 28px; height: 28px; justify-self: center; }
    .reward-slot-icon {
        width: 100%; height: 100%; object-fit: contain; background-color: #f0f0f0;
        border-radius: 4px; padding: 2px; box-sizing: border-box; transition: opacity 0.3s ease;
    }
    .reward-slot-counter {
        position: absolute; bottom: -4px; right: -6px; background-color: #0074D9;
        color: white; font-size: 12px; font-weight: bold; padding: 0px 4px;
        border-radius: 50%; border: 1px solid white; box-shadow: 0 0 3px rgba(0, 0, 0, 0.5); display: none;
    }
    .reward-slot.uncollected .reward-slot-icon { opacity: 0.3; }
    .reward-slot.uncollected .reward-slot-counter { display: none; }
    .reward-slot.collected .reward-slot-icon { opacity: 1; }
    .reward-slot.collected .reward-slot-counter { display: block; }

    .reward-display {
        display: none; align-items: center; justify-content: center; gap: 10px;
        margin-top: 15px; padding: 8px 12px; background-color: #fffbe0;
        border: 1px solid #ffecb3; border-radius: 8px;
    }
    .reward-text { font-weight: bold; color: #f57c00; }
    .reward-icon { width: 32px; height: 32px; }
    #back-to-game-btn:hover { background-color: #333; }

    #player-select-backdrop { background-color: rgba(0, 0, 0, 0.7); }
    .player-select-button {
        padding: 15px 20px; font-size: 1.2em; font-weight: bold; border: 2px solid #ddd;
        border-radius: 8px; background-color: #f8f8f8; cursor: pointer; transition: all 0.2s ease;
        color: #333; display: flex; align-items: center; justify-content: center;
        width: 80%; align-self: center; box-sizing: border-box;
    }
    .player-select-button:hover { background-color: #e9e9e9; border-color: #a7c7e7; transform: translateY(-2px); }
    .player-select-button .fas { margin-right: 10px; color: #8bc34a; }

    #ficha-modal-backdrop {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7); z-index: 2000; display: none;
        justify-content: center; align-items: center;
    }
    #ficha-modal {
        background-color: #f9f9f9; padding: 25px 30px; border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); text-align: center; width: 50%; max-width: 350px;
    }
    #ficha-modal h2 { color: #a7c7e7; font-size: 1.6em; margin-top: 0; margin-bottom: 25px; }
    .ficha-choices { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
    .ficha-container {
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        cursor: pointer; transition: transform 0.2s ease;
    }
    .ficha-container:hover { transform: scale(1.1); }
    .ficha-option {
        width: 70px; height: 70px; border-radius: 50%; border: 4px solid #ddd;
        background-color: #ffffff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease; object-fit: contain; padding: 5px; box-sizing: border-box;
    }
    .ficha-container:hover .ficha-option { border-color: #8bc34a; box-shadow: 0 4px 10px rgba(139, 195, 74, 0.4); }
    .ficha-name { font-size: 0.9em; font-weight: 600; color: #333; text-align: center; }
    .ficha-container.selected { opacity: 0.5; cursor: not-allowed; }
    .ficha-container.selected .ficha-option { filter: grayscale(100%); }
    .ficha-container.selected:hover { transform: scale(1); }
    .ficha-container.selected:hover .ficha-option { border-color: #ddd; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }

    .player-select-button.disabled-level {
        background-color: #f0f0f0; border-color: #e0e0e0; color: #aaa;
        cursor: not-allowed; opacity: 0.7;
    }
    .player-select-button.disabled-level .fas { color: #aaa; }
    .player-select-button .coming-soon { font-size: 0.8em; font-weight: normal; margin-left: 8px; opacity: 0.9; }

    #info-modal-close-button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    #info-modal-reward-icon { width: 24px; height: 24px; }
    #reward-modal-close-button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    #reward-modal-icon { width: 24px; height: 24px; }

    #event-modal-title { font-size: 1.6em; font-weight: bold; margin-top: 0; margin-bottom: 15px; text-transform: uppercase; }
    #event-modal-title.advantage { color: #4CAF50; }
    #event-modal-title.trap { color: #F44336; }

    #game-info-modal { max-width: 650px; text-align: left; }
    #game-info-modal h4, #game-info-modal p, #game-info-modal ul, #game-info-modal table {
        margin-top: 0; margin-bottom: 0; padding: 0;
    }
    #game-info-modal h4 { font-size: 1.2em; font-weight: bold; color: #333; margin-top: 24px; margin-bottom: 10px; }
    #game-info-modal p { margin-bottom: 16px; line-height: 1.4; }
    #game-info-modal ul { margin-bottom: 16px; padding-left: 30px; line-height: 1.6; }
    .info-legend-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
    .info-legend-table th, .info-legend-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; text-align: left; }
    .info-legend-table th { background-color: #f8f8f8; font-weight: bold; color: #555; text-transform: uppercase; font-size: 0.9em; }
    .info-legend-table td:first-child { width: 50px; text-align: center; }
    .info-legend-table td:nth-child(2) { width: 35%; }
    .legend-square-icon { width: 40px; height: 40px; object-fit: contain; display: block; margin: 0 auto; }

    #game-over-backdrop {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85); z-index: 5000; display: none;
        justify-content: center; align-items: center; flex-direction: column;
        opacity: 0; transition: opacity 1s ease-in-out;
    }
    #game-over-backdrop.visible { opacity: 1; }
    #game-over-content { text-align: center; color: white; }
    #confetti-gif { width: 250px; height: auto; margin-bottom: 20px; opacity: 0; transform: scale(0.5); animation: confetti-pop-in 1s forwards; }
    #game-over-content h2 {
        font-size: 3em; font-family: 'Lora', serif; margin: 0; color: #8bc34a;
        text-shadow: 0 0 15px rgba(139, 195, 74, 0.7); animation: pulse-text-large 2s infinite;
    }
    #game-over-content p { font-size: 1.5em; font-family: Arial, sans-serif; margin-top: 10px; color: white; }

    @keyframes pulse-text-large {
        0% { transform: scale(0.95); } 50% { transform: scale(1.05); } 100% { transform: scale(0.95); }
    }
    @keyframes confetti-pop-in {
        0% { opacity: 0; transform: scale(0.5) translateY(50px); }
        70% { opacity: 1; transform: scale(1.1) translateY(-10px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    #final-score-modal { max-width: 500px; text-align: center; }
    #final-score-icon { font-size: 4em; color: #FFC107; margin-bottom: 15px; animation: trophy-bounce 2s infinite; display: flex; justify-content: center; align-items: center; width: 100%; }
    @keyframes trophy-bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-20px); }
        60% { transform: translateY(-10px); }
    }
    #final-score-title { color: #055513; font-size: 2em; margin-top: 0; margin-bottom: 20px; }
    #final-score-details { font-size: 1.1em; color: #333; line-height: 1.6; margin-bottom: 25px; text-align: left; }
    #final-score-details h4 { text-align: center; margin-bottom: 10px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .score-entry { display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
    .score-entry:last-child { border-bottom: none; }
    .score-entry-name { font-weight: 600; }
    .score-entry-score { font-weight: bold; color: #0074D9; }
    .score-entry.winner { background-color: #fffbe0; border-radius: 6px; }
    .score-entry.winner .score-entry-name { color: #f57c00; }
    #play-again-button { padding: 12px 30px; font-size: 1.1em; font-weight: bold; }

    @media (min-width: 1400px) {
        .player-stat-row .player-ficha-icon { width: 45px; height: 45px; }
    }
    .ficha-del-jugador { display: flex; flex-direction: row; width: 350px; }
    @media (max-width: 600px) {
        .ficha-del-jugador { width: 95%; margin: 0 auto; flex-direction: column; align-items: stretch; }
        .ficha-del-jugador h3, .ficha-del-jugador p { padding: 5px; text-align: center; }
        
        /* Ajuste del dado en móvil */
        #dice-container { bottom: 10px; left: 10px; }
        .dice-scene, .dice-cube .dice-face { width: 60px; height: 60px; }
        .dice-cube { transform: translateZ(-30px); }
        .pip { width: 8px; height: 8px; }
    }
</style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>

<body>

    <div class="dashboard-container">
        <header>
            <a href="#" id="game-info-button" class="settings-button" title="Información del Juego">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                       
                    <path fill-rule="evenodd"
                        d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.25-1.06a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V12a.75.75 0 01.75-.75zM10.5 8.25a.75.75 0 000 1.5.75.75 0 000-1.5z"
                        clip-rule="evenodd" />
                                   
                </svg>
                            </a>
            <a href="admin.html" target="_blank" class="settings-button" title="Administrador">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.23 C14.38,2,14.17,1.84,13.92,1.84h-3.84c-0.25,0-0.46,0.16-0.49,0.39l-0.34,2.55c-0.58,0.23-1.12,0.55-1.62,0.93L5.24,4.75 c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.29C2.62,8.49,2.68,8.76,2.86,8.9l2.03,1.58C4.84,10.8,4.82,11.1,4.82,11.4 c0,0.3,0.02,0.6,0.06,0.9l-2.03,1.58c-0.18,0.14-0.24,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22 l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.34,2.55c0.02,0.24,0.23,0.4,0.49,0.4h3.84c0.25,0,0.46-0.16,0.49-0.39 l0.34-2.55c0.58-0.23,1.12-0.55,1.62-0.93l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32 c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6 S13.98,15.6,12,15.6z" />
                </svg>
            </a>
        </header>
        <main>

            <div id="video-screen" class="screen active">
                <video id="local-video-player" width="100%" height="100%" playsinline muted controls>

                    <source src="assets/video/intro_biblioteca.mp4" type="video/mp4">

                </video>
            </div>
            <div id="level-select-backdrop" class="modal-backdrop">
                <div id="level-select-modal" class="modal-content">
                    <h2>Selecciona un Nivel</h2>
                    <p>Elige la aventura que quieres comenzar.</p>

                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">

                        <button id="btn-level-1" class="player-select-button">
                            <i class="fas fa-map-signs"></i> Nivel 1: Ruta Imbabura
                        </button>

                        <button id="btn-level-2" class="player-select-button disabled-level" disabled>
                            <i class="fas fa-lock"></i> Nivel 2 <span class="coming-soon">(Próximamente)</span>
                        </button>
                        <button id="btn-level-3" class="player-select-button disabled-level" disabled>
                            <i class="fas fa-lock"></i> Nivel 3 <span class="coming-soon">(Próximamente)</span>
                        </button>
                        <button id="btn-level-4" class="player-select-button disabled-level" disabled>
                            <i class="fas fa-lock"></i> Nivel 4 <span class="coming-soon">(Próximamente)</span>
                        </button>

                    </div>
                </div>
            </div>

            <div id="map-screen" class="screen">

                <div id="map-zoom-container">

                    <img id="map-image" src="assets/mapa_imbabura.png" alt="Mapa del Juego Interactivo">

                </div>
                <div id="zoom-loader-backdrop">
                    <div id="zoom-loader-text">Cargando la ruta...</div>
                </div>
                <div id="player-stats-container">
                </div>

                <div id="dice-container">

                    <div id="turn-indicator" class="turn-indicator">
                        <span id="turn-indicator-name">Jugador</span>, ¡es tu turno!
                    </div>

                    <div id="dice-face" class="dice-scene">
                        <div id="dice-cube" class="dice-cube">

                            <div class="dice-face" id="face-1">
                                <span class="pip c"></span>
                            </div>

                            <div class="dice-face" id="face-2">
                                <span class="pip tl"></span>
                                <span class="pip br"></span>
                            </div>

                            <div class="dice-face" id="face-3">
                                <span class="pip tl"></span>
                                <span class="pip c"></span>
                                <span class="pip br"></span>
                            </div>

                            <div class="dice-face" id="face-4">
                                <span class="pip tl"></span>
                                <span class="pip tr"></span>
                                <span class="pip bl"></span>
                                <span class="pip br"></span>
                            </div>

                            <div class="dice-face" id="face-5">
                                <span class="pip tl"></span>
                                <span class="pip tr"></span>
                                <span class="pip c"></span>
                                <span class="pip bl"></span>
                                <span class="pip br"></span>
                            </div>

                            <div class="dice-face" id="face-6">
                                <span class="pip tl"></span>
                                <span class="pip tr"></span>
                                <span class="pip cl"></span>
                                <span class="pip cr"></span>
                                <span class="pip bl"></span>
                                <span class="pip br"></span>
                            </div>

                        </div>
                    </div>
                </div>
            </div>


            <div id="player-select-backdrop" class="modal-backdrop">
                <div id="player-select-modal" class="modal-content">

                    <p>Selecciona el número de jugadores para
                        esta partida.</p>

                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button id="btn-1-player" class="player-select-button">
                            <i class="fas fa-user"></i> 1 Jugador
                        </button>
                        <button id="btn-2-players" class="player-select-button">
                            <i class="fas fa-user-friends"></i> 2 Jugadores
                        </button>
                        <button id="btn-3-players" class="player-select-button">
                            <i class="fas fa-users"></i> 3 Jugadores
                        </button>
                    </div>

                    <div class="download-section"
                        style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">

                        <p style="font-size: 0.9em; color: #666; margin: 0 0 15px 0;">
                            Para vivir la experiencia completa, es indispensable tener la app ITCA Academy en tu
                            celular. Escanea el QR y descarga la aplicación.
                        </p>
                        <div class="qr-container">
                            <img src="assets/qr_app.png" alt="Código QR para descargar la app"
                                style="width: 140px; height: 140px;">
                        </div>


                    </div>

                </div>
            </div>
            <div id="registration-modal-backdrop">
                <div id="registration-modal">
                    <div class="modal-header">
                        <h2>Registro de Jugador</h2>

                    </div>
                    <form id="registration-form">
                        <label for="playerCedula">Cédula:</label>
                        <input type="text" id="playerCedula" name="playerCedula" autocomplete="off" maxlength="10">

                        <label for="playerName">Nombres y Apellidos:</label>
                        <input type="text" id="playerName" name="playerName" autocomplete="off">

                        <label for="playerEmail">Correo Electrónico:</label>
                        <input type="email" id="playerEmail" name="playerEmail" autocomplete="off">

                        <label for="playerPhone">Teléfono:</label>
                        <input type="tel" id="playerPhone" name="playerPhone">

                        <label for="playerAge">Edad:</label>
                        <input type="number" id="playerAge" name="playerAge" min="1">

                        <label for="playerGender">Género:</label>
                        <select id="playerGender" name="playerGender">
                            <option value="" disabled selected>Selecciona una opción</option>
                            <option value="MASCULINO">MASCULINO</option>
                            <option value="FEMENINO">FEMENINO</option>
                            <option value="PREFIERO NO DECIRLO">PREFIERO NO DECIRLO</option>
                        </select>

                        <label for="playerCity">Ciudad:</label>
                        <input type="text" id="playerCity" name="playerCity" autocomplete="off">

                        <button type="submit" disabled>
                            <i class="fas fa-gamepad"></i> Registrar jugador
                        </button>
                    </form>
                </div>
            </div>


            <div id="info-modal-backdrop" class="modal-backdrop">
                <div id="info-modal" class="modal-content">
                    <h2 id="info-modal-title"></h2>
                    <div class="info-modal-visual">
                        <img id="info-modal-image" src="" alt="Lugar de interés">

                        <span style="color: red;">¡Es necesario escanear la imagen con tu celular!</span>

                    </div>

                    <div class="info-modal-text">
                        <p id="info-modal-description"></p>
                        <button id="info-modal-close-button">
                            <img id="info-modal-reward-icon" class="reward-icon" src="" alt="Recompensa"
                                style="display: none;">
                            <span id="info-modal-button-text">¡Reclamar premio!</span>
                        </button>
                    </div>

                </div>
            </div>

            <div id="reward-modal-backdrop" class="modal-backdrop">
                <div id="reward-modal" class="modal-content">
                    <h2 id="reward-modal-title"></h2>
                    <p id="reward-modal-description"></p>

                    <button id="reward-modal-close-button">
                        <img id="reward-modal-icon" class="reward-icon" src="" alt="Recompensa" style="display: none;">

                        <span id="reward-modal-button-text">¡Reclamar premio!</span>
                    </button>
                </div>
            </div>

            <div id="question-modal-backdrop" class="modal-backdrop">
                <div id="question-modal" class="modal-content">
                    <h2 id="question-title">¡Pregunta Sorpresa!</h2>
                    <p id="question-text"></p>
                    <div id="question-options"></div>
                    <p id="question-feedback"></p>
                    <div class="reward-display" id="question-modal-reward">
                        <img class="reward-icon" src="" alt="Recompensa">
                    </div>
                    <button id="question-continue-button" style="display: none;">Continuar</button>
                </div>
            </div>

            <div id="event-modal-backdrop" class="modal-backdrop">
                    <div id="event-modal" class="modal-content">
                           
                                    <h2 id="event-modal-title"></h2>

                            <p id="event-text"></p>
                            <div id="event-icon-container"></div>
                            <button id="event-modal-close-button">Entendido</button>
                        </div>
            </div>

            <div id="ficha-modal-backdrop">
                <div id="ficha-modal">
                    <h2>Elige tu ficha</h2>
                    <div class="ficha-choices">

                        <div class="ficha-container">
                            <img src="assets/fichas/ficha_1.png" alt="Paila" class="ficha-option" data-ficha="hombre"
                                title="Paila de Helado">
                            <span class="ficha-name">Paila de Helado</span>
                        </div>

                        <div class="ficha-container">
                            <img src="assets/fichas/ficha_2.png" alt="Columpio" class="ficha-option" data-ficha="mujer"
                                title="Columpio">
                            <span class="ficha-name">Columpio</span>
                        </div>

                        <div class="ficha-container">
                            <img src="assets/fichas/ficha_3.png" alt="Sombrero" class="ficha-option" data-ficha="animal"
                                title="Sombrero">
                            <span class="ficha-name">Sombrero</span>
                        </div>

                        <div class="ficha-container">
                            <img src="assets/fichas/ficha_4.png" alt="Chakana" class="ficha-option" data-ficha="chakana"
                                title="Chakana">
                            <span class="ficha-name">Chakana</span>
                        </div>

                        <div class="ficha-container">
                            <img src="assets/fichas/ficha_5.png" alt="Hilo" class="ficha-option" data-ficha="hilo"
                                title="Hilo de Algodón">
                            <span class="ficha-name">Hilo de Algodón</span>
                        </div>

                        <div class="ficha-container">
                            <img src="assets/fichas/ficha_6.png" alt="Cabaña" class="ficha-option" data-ficha="cabaña"
                                title="Cabaña">
                            <span class="ficha-name">Cabaña</span>
                        </div>

                    </div>
                </div>
            </div>
            <div id="game-info-backdrop" class="modal-backdrop" style="display: none;">
                            <div id="game-info-modal" class="modal-content">
                                    <h3 style="text-align: center; color: #0074D9; text-transform: uppercase;">TE VIVO
                        IMBABURA</h3>
                                   
                                    <h4>Acerca del Juego</h4>
                                   
                                    <p>¡Bienvenido a la aventura "Te Vivo Imbabura"! Este juego de tablero interactivo
                        te invita a recorrer los puntos turísticos más emblemáticos de nuestra provincia.</p>
                                   
                                    <h4>¿Cómo Jugar?</h4>
                                    <ul>
                                            <li>Elige el número de jugadores y registra tus datos.</li>
                                            <li>Selecciona tu ficha favorita para representar tu viaje.</li>
                                            <li>En tu turno, ¡lanza el dado!</li>
                                                                <li>Tu ficha hará <strong>paradas obligatorias</strong>
                            en las casillas de "Parada" (puntos de información).</li>
                                            <li>¡El jugador que llegue a la meta con más puntos gana!</li>
                                        </ul>

                                    <h4>Simbología del Tablero</h4>
                                    <table class="info-legend-table">
                                            <thead>
                                                    <tr>
                                                      <th>Casilla</th>
                                                            <th>Nombre</th>
                                                            <th>Descripción</th>
                                                        </tr>
                                                </thead>
                                            <tbody>
                                                    <tr>
                                <td><img src="assets/descripcion_casillas/punto.png" class="legend-square-icon"></td>
                                <td><strong>Parada</strong></td>
                                <td>Recibe información y premios.</td>
                            </tr>
                                                    <tr>
                                <td><img src="assets/descripcion_casillas/casillasegura.png" class="legend-square-icon">
                                </td>
                                <td><strong>Casilla segura</strong></td>
                                <td>Un punto de descanso. No pasa nada en esta casilla.</td>
                            </tr>
                                                    <tr>
                                <td><img src="assets/descripcion_casillas/recompensa.png" class="legend-square-icon">
                                </td>
                                <td><strong>Datos informativos</strong></td>
                                <td>Recibe pequeños datos informativos y premios.</td>
                            </tr>
                                                  <tr>
                                <td><img src="assets/descripcion_casillas/pregunta.png" class="legend-square-icon"></td>
                                <td><strong>Pregunta</strong></td>
                                <td>Responde para ganar o perder puntos.</td>
                            </tr>
                                                    <tr>
                                <td><img src="assets/descripcion_casillas/trampa.png" class="legend-square-icon"></td>
                                <td><strong>Trampa</strong></td>
                                <td>¡Cuidado! Una penalización.</td>
                            </tr>
                                                    <tr>
                                <td><img src="assets/descripcion_casillas/ventaja.png" class="legend-square-icon"></td>
                                <td><strong>Ventaja</strong></td>
                                <td>¡Suerte! Un premio o atajo.</td>
                            </tr>
                                            </tbody>
                                        </table>
                                   
                                    <button id="game-info-close-btn"
                        style="display: block; margin: 20px auto 0 auto;">Cerrar</button>
                                </div>
                        </div>
            <div id="game-over-backdrop">
                <div id="game-over-content">
                    <img id="confetti-gif" src="assets/video/gif_finpartida.gif" alt="Confeti" />

                    <p id="game-over-text"></p>
                </div>
            </div>

            <div id="final-score-backdrop" class="modal-backdrop">
                <div id="final-score-modal" class="modal-content">
                    <div id="final-score-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h2 id="final-score-title">¡Aventura Completada!</h2>
                    <div id="final-score-details">
                    </div>
                    <button id="play-again-button">Jugar de Nuevo</button>
                </div>
            </div>

            <audio id="bg-music" loop>
                <source src="assets/audio/audio_TevivoImbabura.mp3" type="audio/mpeg">
            </audio>
            <audio id="dice-sound">
                <source src="assets/audio/audio_dado.mp3" type="audio/mpeg">
            </audio>

        </main>
    </div>
    <script>
        // --- ¡NUEVA LÓGICA PARA MODAL DE INFO DE JUEGO! ---
        document.addEventListener('DOMContentLoaded', () => {
            const gameInfoButton = document.getElementById('game-info-button');
            const gameInfoBackdrop = document.getElementById('game-info-backdrop');
            const gameInfoCloseBtn = document.getElementById('game-info-close-btn');

            if (gameInfoButton) {
                gameInfoButton.addEventListener('click', (e) => {
                    e.preventDefault(); // Evita que el enlace '#' recargue la página
                    gameInfoBackdrop.style.display = 'flex';
                    setTimeout(() => gameInfoBackdrop.classList.add('visible'), 10);
                });
            }

            if (gameInfoCloseBtn) {
                gameInfoCloseBtn.addEventListener('click', () => {
                    gameInfoBackdrop.classList.remove('visible');

                    setTimeout(() => gameInfoBackdrop.style.display = 'none', 400); // 400ms = duración de la transición
                });
            }
        });
        // ===========================================
        // 1. DATOS DE NIVELES
        // ===========================================

        const LEVEL_1_DATA = {
            levelId: "level_1_imbabura",
            levelName: "Ruta Imbabura",
            assets: {
                mapImage: "assets/mapa_imbabura.png",
                // videoIntro: "assets/video/intro_biblioteca.mp4", // <-- ¡CORREGIDO! (Eliminado de aquí)
                bannerHeader: "assets/banner_tvi.png"
            },
            path: [
                { top: '58.13%', left: '71.18%' },     // 0 (Salida)
                { top: '59.60%', left: '72.38%' }, //1
                { top: '60.57%', left: '73.49%' },    // 2
                { top: '61.96%', left: '74.51%' },     // 3
                { top: '63.10%', left: '75.38%' },    // 4
                { top: '64.29%', left: '76.33%' },     // 5
                { top: '65.77%', left: '77.35%' },     // 6
                { top: '66.35%', left: '78.67%' },     // 7
                { top: '68.04%', left: '79.94%' },     // 8
                { top: '70.14%', left: '79.37%' }, // 9
                { top: '71.41%', left: '78.23%' },     // 10
                { top: '72.16%', left: '77.08%' },     // 11
                { top: '73.05%', left: '75.72%' },     // 12
                { top: '73.67%', left: '74.34%' },     // 13
                { top: '74.10%', left: '73.19%' },     // 14
                { top: '74.41%', left: '71.90%' },     // 15
                { top: '74.56%', left: '70.49%' },     // 16
                { top: '74.44%', left: '69.04%' },     // 17
                { top: '73.67%', left: '67.55%' },     // 18
                { top: '72.20%', left: '66.42%' },     // 19
                { top: '70.80%', left: '65.39%' },     // 20
                { top: '69.84%', left: '64.09%' },     // 21
                { top: '69.41%', left: '62.84%' },     // 22
                { top: '68.22%', left: '61.64%' },     // 23
                { top: '65.59%', left: '61.44%' },     // 24
                { top: '64.28%', left: '62.89%' },     // 25
                { top: '64.01%', left: '64.22%' },     // 26
                { top: '62.85%', left: '65.36%' },     // 27
                { top: '60.68%', left: '65.93%' },     // 28
                { top: '58.29%', left: '65.78%' },     // 29
                { top: '56.23%', left: '65.01%' },     // 30
                { top: '54.18%', left: '64.44%' },     // 31
                { top: '51.67%', left: '64.07%' },     // 32
                { top: '49.31%', left: '64.53%' },     // 33
                { top: '47.88%', left: '65.56%' },     // 34
                { top: '46.07%', left: '66.44%' }, // 35
                { top: '43.75%', left: '67.01%' },     // 36
                { top: '41.61%', left: '67.09%' },    // 37 
                { top: '39.05%', left: '66.81%' },   // 38
                { top: '36.49%', left: '65.96%' },   // 39
                { top: '34.32%', left: '65.18%' },   // 40
                { top: '31.62%', left: '64.87%' },  // 41
            ],
            gameData: {
                // ... (Todos tus datos de gameData van aquí, sin cambios) ...
                infoPoints: {
                    '1': {
                        title: "HELADOS DE PAILA",
                        image: "assets/lugares/helados_paila.png",
                        description: "Has llegado a la cuna de los famosos helados de paila.<b> ¡Obtienes 5 puntos y 1 helado!</b>",
                        pointsGained: 5,
                        rewardId: 'helado'
                    },
                    '8': {
                        title: "MIRADOR DE ANGOCHAGUA",
                        image: "assets/lugares/mirador_muchanajurumi.png",
                        description: "Disfrutas de una vista espectacular desde el mirador Mucha Naju Rumi. <b>¡Obtienes 5 puntos y 1 árbol!</b>",
                        pointsGained: 5,
                        rewardId: 'arbol'
                    },
                    '18': {
                        title: "PLAZA DE PONCHOS",
                        image: "assets/lugares/plaza_deponchos.png",
                        description: "Estás en el mercado artesanal más grande de Sudamérica. <b>¡Obtienes 5 puntos y 1 poncho.</b>",
                        pointsGained: 5,
                        rewardId: 'poncho'
                    },
                    '23': {
                        title: "LAGUNA DE CUICOCHA",
                        image: "assets/lugares/lago_cuicocha.png",
                        description: "Navegas por el 'Lago de los Dioses'. <b>¡Obtienes 5 puntos y 1 canoa.</b>",
                        pointsGained: 5,
                        rewardId: 'canoa'
                    },
                    '28': {
                        title: "FÁBRICA IMBABURA",
                        image: "assets/lugares/fabrica_imbabura.png",
                        description: "Visitas el histórico complejo textil. <b>¡Obtienes 5 puntos y 1 algodón.</b>",
                        pointsGained: 5,
                        rewardId: 'algodon'
                    },
                    '36': {
                        title: "MONTAÑA DE LUZ",
                        image: "assets/lugares/montaña_deluz.png",
                        description: "Llegas a un lugar de paz y sanación. <b>¡Obtienes 10 puntos y 1 árbol simbólico!.</b>",
                        pointsGained: 10,
                        rewardId: 'arbol'
                    },
                },

                rewardPoints: {
                    '3': {
                        title: "Dato Curioso",
                        description: "Uno de los acompañantes más frecuentes en el consumo de los helados de paila es la quesadilla.<br><br><b>¡Ganas 5 puntos y 1 Helado!</b>",
                        pointsGained: 5,
                        rewardId: 'helado'
                    },
                    '5': {
                        title: "Dato Curioso",
                        description: "La producción y comercialización de helados dinamiza la agricultura y la economía locales.<br><br><b>¡Ganas 5 puntos!</b>",
                        pointsGained: 5,

                    },
                    '9': {
                        title: "Dato Curioso",
                        description: "El mirador Mucha Naju Rumi está a una altitud de 2880 msnm.<br><br><b>¡Ganas 5 puntos y 1 Árbol!</b>",
                        pointsGained: 5,
                        rewardId: 'arbol'
                    },
                    '14': {
                        title: "Dato Curioso",
                        description: "Desde este mirador se pueden apreciar varios volcanes, tales como: Taita Imbabura, Cubilche, Cuzín.<br><br><b>¡Ganas 5 puntos y 1 Árbol!</b>",
                        pointsGained: 5,
                        rewardId: 'arbol'
                    },
                    '16': {
                        title: "Dato Curioso",
                        description: "En el trayecto al mirador se pueden observar una variedad de plantas y árboles como: achupallas, alisos, eucaliptos.<br><br><b>¡Ganas 5 puntos y 1 Árbol!</b>",
                        pointsGained: 5,
                        rewardId: 'arbol'
                    },
                    '20': {
                        title: "Dato Cultural",
                        description: "Alrededor de la plaza de ponchos se pueden encontrar espacios culturales para vivir las costumbres y tradiciones locales.<br><br><b>¡Ganas 5 puntos y 1 Poncho!</b>",
                        pointsGained: 5,
                        rewardId: 'poncho'
                    },
                    '22': {
                        title: "Dato de Artesanía",
                        description: "Además de textiles, en la plaza puedes encontrar figuras talladas en 'tagua', una semilla tan dura que se la conoce como 'marfil vegetal'.<br><br><b>¡Ganas 5 puntos y 1 Poncho!</b>",
                        pointsGained: 5,
                        rewardId: 'poncho'
                    },

                    '25': {
                        title: "Dato Cultural",
                        description: "En la Ruta Sagrada se pueden encontrar simbolismos de los pueblos originarios como la Chacana y el calendario lunar.<br><br><b>¡Ganas 5 puntos y 1 Canoa!</b>",
                        pointsGained: 5,
                        rewardId: 'canoa'
                    },

                    '32': {
                        title: "Dato Histórico",
                        description: "La fecha de fundación de la Fábrica Imbabura es 1924.<br><br><b>¡Ganas 5 puntos y 1 Algodón!</b>",
                        pointsGained: 5,
                        rewardId: 'algodon'
                    },
                    '34': {
                        title: "Dato Histórico",
                        description: "Fábrica Imbabura, en su época de apogeo dinamizó la producción agrícola de algodón de los valles de Salinas y el Chota.<br><br><b>¡Ganas 5 puntos y 1 Algodón!</b>",
                        pointsGained: 5,
                        rewardId: 'algodon'
                    },
                    '40': {
                        title: "Dato Curioso",
                        description: "En Montaña de Luz se ofrecen servicios de alimentación preparados con productos orgánicos, cultivados en el mismo lugar.<br><br><b>¡Ganas 5 puntos y 1 Árbol!</b>",
                        pointsGained: 5,
                        rewardId: 'arbol'
                    },
                },
                questionPoints: {
                    '4': { question: "¿Cuál es el nombre de la promotora de los helados de paila más reconocida?", options: ["María Chuga", "Rosalía Suárez", "Anita Benavides"], correctAnswer: 1, pointsGained: 5, pointsLost: 3, rewardId: 'helado', feedback: { correct: "¡Correcto! Rosalía Suárez es la pionera. Ganas 5 puntos y 1 Helado.", incorrect: "Respuesta incorrecta. La promotora más famosa es Rosalía Suárez. Pierdes 3 puntos." } },
                    '7': { question: "¿Cuál es el instrumento más característico en la elaboración de los helados de paila?", options: ["Paila de cobre", "Banca de madera", "Congelador"], correctAnswer: 0, pointsGained: 5, pointsLost: 3, feedback: { correct: "¡Correcto! La paila de cobre es esencial. Ganas 5 puntos.", incorrect: "Incorrecto. El instrumento clave es la paila de cobre. Pierdes 3 puntos." } },
                    '11': { question: "¿En qué lengua está escrito Mucha Naju Rumi?", options: ["Inglés", "Alemán", "Kichwa"], correctAnswer: 2, pointsGained: 5, pointsLost: 2, feedback: { correct: "¡Correcto! Está en Kichwa. Ganas 5 puntos.", incorrect: "Incorrecto. La lengua es Kichwa. Pierdes 2 puntos." } },
                    '15': { question: "¿Conoces la traducción de Mucha Naju Rumi al español?", options: ["Lugar donde se besan las rocas", "Lugar donde se rompen las rocas", "Lugar donde brincan las rocas"], correctAnswer: 0, pointsGained: 5, pointsLost: 3, feedback: { correct: "¡Excelente! Significa 'Lugar donde se besan las rocas'. Ganas 5 puntos.", incorrect: "Incorrecto. La traducción es 'Lugar donde se besan las rocas'. Pierdes 3 puntos." } },
                    '21': { question: "¿La plaza de ponchos de Otavalo es una de las ferias artesanales más grandes de América Latina?", options: ["Sí", "No"], correctAnswer: 0, pointsGained: 5, pointsLost: 3, feedback: { correct: "¡Así es! Es famosa en todo el continente. Ganas 5 puntos.", incorrect: "Incorrecto. Es una de las más grandes y famosas. Pierdes 3 puntos." } },
                    '26': { question: "El domo interior más grande del lago Cuicocha, se llama:", options: ["Yaguarcocha", "Cuicocha", "Teodoro Wolf"], correctAnswer: 2, pointsGained: 5, pointsLost: 3, feedback: { correct: "¡Correcto! Se llama Teodoro Wolf. Ganas 5 puntos.", incorrect: "Incorrecto. El domo más grande es el Teodoro Wolf. Pierdes 3 puntos." } },
                    '30': { question: "¿Sabes qué tipo de telas se producían especialmente en Fábrica Imbabura?", options: ["Telas de poliester", "Telas de algodón", "Telas de poliester y algodón"], correctAnswer: 1, pointsGained: 5, pointsLost: 3, feedback: { correct: "¡Correcto! Eran especialistas en telas de algodón. Ganas 5 puntos.", incorrect: "Incorrecto. La producción principal era de telas de algodón. Pierdes 3 puntos." } },
                    '33': { question: "¿En qué cantón está localizada la Fábrica Imbabura?", options: ["Otavalo", "Cotacachi", "Antonio Ante"], correctAnswer: 2, pointsGained: 5, pointsLost: 3, feedback: { correct: "¡Exacto! Se encuentra en Antonio Ante. Ganas 5 puntos.", incorrect: "Incorrecto. La fábrica está en el cantón Antonio Ante. Pierdes 3 puntos." } },
                    '38': {
                        question: "¿Cuál era el nombre original de la parroquia Pablo Arenas?",
                        options: ["Cruzcacho", "Angochagua", "San Pablo"],
                        correctAnswer: 0,
                        pointsGained: 5,
                        pointsLost: 3,
                        rewardId: 'arbol', // <-- ¡AÑADIDO!
                        feedback: {
                            correct: "¡Correcto! El nombre original era Cruzcacho. Ganas 5 puntos y 1 Árbol.", // <-- ¡TEXTO MEJORADO!
                            incorrect: "Incorrecto. La respuesta correcta es Cruzcacho. Pierdes 3 puntos."
                        }
                    },

                },
                eventPoints: {
                    '6': {
                        type: 'trap',
                        conditionItem: 'helado', // Revisa si tienes un helado

                        // Falla (No tiene helado)
                        text_fail: "¡Se te antoja un helado! Te distraes pensando en volver a la paila. Retrocedes 1 casilla.",
                        move_fail: -1, // Retrocede

                        // Éxito (Sí tiene helado)
                        text_success: "¡Oh no! Por la emoción del viaje, se te cae el helado que traías. Pierdes 1 Helado, pero por suerte no retrocedes.",
                        itemLost: 'helado', // Pierde el helado
                        move_success: 0 // No retrocede
                    },
                    '12': { type: 'trap', text: "Una densa neblina cubre el mirador y te desorientas por completo. Regresas 3 casillas.", move: -3 },

                    '27': {
                        type: 'trap', // Sigue siendo una trampa en el núcleo
                        conditionItem: 'poncho', // ¡NUEVO! El ítem que revisará

                        // Texto si NO tienes el ítem (Fallo)
                        text_fail: "¡El viento helado de la laguna te golpea! No tienes poncho para abrigarte y el soroche te marea. Pierdes 3 puntos.",
                        pointsLost_fail: 3, // Puntos perdidos si fallas

                        // Texto si SÍ tienes el ítem (Éxito)
                        text_success: "¡El viento helado de la laguna te golpea! Por suerte, usas tu poncho para abrigarte. ¡Te salvas de perder puntos, pero pierdes 1 Poncho!",
                        itemLost: 'poncho' // Ítem que se pierde al tener éxito
                    },
                    '31': {
                        type: 'trap',
                        conditionItem: 'algodon', // Revisa si tienes algodón

                        // Falla (No tiene algodón)
                        text_fail: "¡Qué descuido! Te acercas demasiado a la maquinaria. Te llevas un susto y te obligan a retroceder 2 casillas.",
                        move_fail: -2, // Retrocede

                        // Éxito (Sí tiene algodón)
                        text_success: "¡Por un descuido, una de las máquinas engancha tu materia prima! Logras rescatarla, pero pierdes 1 Algodón en el proceso.",
                        itemLost: 'algodon', // Pierde el algodón
                        move_success: 0 // No retrocede}
                    },
                    '39': {
                        type: 'trap',
                        text: "¡El paisaje desde la 'Montaña de Luz' es espectacular! Te distraes tanto admirando el Geoparque que se te hace tarde. Pierdes 5 puntos.",
                        pointsLost: 5
                    },
                    '17': { type: 'advantage', text: "Descubres un camino menos empinado y tomas un atajo. ¡Avanzas 2 casillas!", move: 2 },
                    '29': { type: 'advantage', text: "Llegas a la FÁBRICA IMBABURA, un lugar lleno de historia. ¡Ganas 3 puntos y una muestra de Algodón!", pointsGained: 3, rewardId: 'algodon' },

                },
                finalMessage: {
                    '41': { text: "¡Felicidades, has culminado la Aventura en Imbabura!" }
                }
            }
        };

        const LEVEL_2_DATA = {
            levelId: "level_2_proximamente",
            levelName: "Nivel 2 (Próximamente)",
            assets: {
                mapImage: "assets/mapa_placeholder.png",
                bannerHeader: "assets/banner_tvi.png"
            },
            path: [
                { top: '50%', left: '50%' },
                { top: '55%', left: '55%' },
            ],
            gameData: {
                infoPoints: {
                    '1': { title: "NUEVO PUNTO", description: "¡Bienvenido al Nivel 2!", pointsGained: 10 }
                },
                rewardPoints: {},
                questionPoints: {},
                eventPoints: {},
                finalMessage: {
                    '1': { text: "¡Felicidades, terminaste el Nivel 2!" }
                }
            }
        };

        // ===========================================
        // 2. CONFIGURACIÓN DE FIREBASE (SIN CAMBIOS)
        // ===========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDtgE2I0eYet03R6VfeXvgvXtEpdAUaYSo",
            authDomain: "juego-te-vivo-imababura.firebaseapp.com",
            projectId: "juego-te-vivo-imababura",
            storageBucket: "juego-te-vivo-imababura.firebasestorage.app",
            messagingSenderId: "54108968941",
            appId: "1:54108968941:web:2ac23cd1eac1e6781b39e4",
            measurementId: "G-320511XQMN"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===========================================
        // 3. ESTADO DEL JUEGO (SIN CAMBIOS)
        // ===========================================
        let activePath = [];
        let activeGameData = {};
        let numPlayers = 1;
        let currentPlayerIndex = 0;
        let gameActive = false;
        let hasVideoFinished = false;
        let isRolling = false;
        let gameOver = false;
        let pendingMove = 0;
        let isZoomedIn = false;
        let playerPositions = [];
        let playerScores = [];
        let playerInventories = [];
        let playerFichaElements = [];
        let playerFichaSrcs = [];
        let selectedFichaIdentifiers = new Set();
        let existingPlayerData = null;
        let playerNames = [];

        // ===========================================
        // 4. ELEMENTOS DEL DOM (SIN CAMBIOS)
        // ===========================================
        const STEP_DURATION_MS = 600;
        const levelSelectBackdrop = document.getElementById('level-select-backdrop');
        const btnLevel1 = document.getElementById('btn-level-1');
        const btnLevel2 = document.getElementById('btn-level-2');
        const btnLevel3 = document.getElementById('btn-level-3');
        const btnLevel4 = document.getElementById('btn-level-4');
        const videoScreen = document.getElementById('video-screen');
        const localVideoPlayer = document.getElementById('local-video-player');

        const mapImageEl = document.getElementById('map-image');
        const headerEl = document.querySelector('header');
        const mapScreen = document.getElementById('map-screen');
        const modalBackdrop = document.getElementById('registration-modal-backdrop');
        const registrationForm = document.getElementById('registration-form');
        const continueButton = registrationForm.querySelector('button[type="submit"]');
        const formInputs = registrationForm.querySelectorAll('input, select');
        const fichaModalBackdrop = document.getElementById('ficha-modal-backdrop');
        const fichaModalTitle = document.getElementById('ficha-modal').querySelector('h2');
        const fichaOptions = document.querySelectorAll('.ficha-option');
        const diceContainer = document.getElementById('dice-container');
        const diceFace = document.getElementById('dice-face');
        const diceCube = document.getElementById('dice-cube');
        const diceImage = diceFace.querySelector('.dice-image');
        const mapZoomContainer = document.getElementById('map-zoom-container');
        const zoomLoaderBackdrop = document.getElementById('zoom-loader-backdrop');
        const turnIndicator = document.getElementById('turn-indicator');
        const turnIndicatorName = document.getElementById('turn-indicator-name');

        const infoModalBackdrop = document.getElementById('info-modal-backdrop');
        const infoModalTitle = document.getElementById('info-modal-title');
        const infoModalImage = document.getElementById('info-modal-image');
        const infoModalDescription = document.getElementById('info-modal-description');
        const infoModalCloseButton = document.getElementById('info-modal-close-button');

        const rewardModalBackdrop = document.getElementById('reward-modal-backdrop');
        const rewardModalTitle = document.getElementById('reward-modal-title');
        const rewardModalDescription = document.getElementById('reward-modal-description');
        const rewardModalCloseButton = document.getElementById('reward-modal-close-button');

        const questionModalBackdrop = document.getElementById('question-modal-backdrop');
        const questionText = document.getElementById('question-text');
        const questionOptions = document.getElementById('question-options');
        const questionFeedback = document.getElementById('question-feedback');
        const questionContinueButton = document.getElementById('question-continue-button');
        const questionModalReward = document.getElementById('question-modal-reward');
        const eventModalBackdrop = document.getElementById('event-modal-backdrop');
        const eventText = document.getElementById('event-text');
        const eventModalCloseButton = document.getElementById('event-modal-close-button');

        const playerSelectBackdrop = document.getElementById('player-select-backdrop');
        const btn1Player = document.getElementById('btn-1-player');
        const btn2Players = document.getElementById('btn-2-players');
        const btn3Players = document.getElementById('btn-3-players');
        const registrationModalTitle = document.getElementById('registration-modal').querySelector('.modal-header h2');
        const playerCedulaInput = document.getElementById('playerCedula');
        const infoModalRewardIcon = document.getElementById('info-modal-reward-icon');
        const infoModalButtonText = document.getElementById('info-modal-button-text');
        const rewardModalIcon = document.getElementById('reward-modal-icon');
        const rewardModalButtonText = document.getElementById('reward-modal-button-text');
        const eventModalTitle = document.getElementById('event-modal-title');
        const eventIconContainer = document.getElementById('event-icon-container');
        const gameOverBackdrop = document.getElementById('game-over-backdrop');
        const gameOverText = document.getElementById('game-over-text');
        const finalScoreBackdrop = document.getElementById('final-score-backdrop');
        const finalScoreDetails = document.getElementById('final-score-details');
        const playAgainButton = document.getElementById('play-again-button');
        const bgMusic = document.getElementById('bg-music');

        // Configurar volumen bajito (10%)
        if (bgMusic) {
            bgMusic.volume = 0.07
                ;
        }
        // --- AGREGA ESTO ---
        const diceSound = document.getElementById('dice-sound');

        // Configuración de volumen (el dado suele necesitar volumen alto)
        if (diceSound) {
            diceSound.volume = 1.0;
        }

        // ¡ESTA LÍNEA ES LA CORRECTA!
        const allPossibleRewards = ['helado', 'arbol', 'poncho', 'canoa', 'algodon'];
        // --- ¡NUEVO! CÓDIGO DE ZONAS DE CÁMARA ---

        const CAMERA_ZONES = {
            'abajo': {
                origin: '73% 70%', // Tu valor original (casillas 0-17)
                transform: 'translateZ(0) scale(5.0)'
            },
            'media': {
                origin: '73% 50%', // Tu valor de "arriba" ahora es "media" (casillas 18-27)
                transform: 'translateZ(0) scale(5.0)'
            },
            'arriba': {
                // ¡NUEVA ZONA! Este es un valor de inicio, ajústalo si es necesario.
                origin: '73% 30%',
                transform: 'translateZ(0) scale(5.0)'
            }
        };

        // Variable para recordar en qué zona estamos
        let currentCameraZone = null;

        // ===========================================
        // 5. FUNCIONES DEL JUEGO (¡CORREGIDAS!)
        // ===========================================

        // --- FUNCIÓN DE CARGA DE NIVEL (¡CORREGIDA!) ---
        function loadLevel(levelData) {
            console.log(`Cargando Nivel: ${levelData.levelName}`);
            activePath = levelData.path;
            activeGameData = levelData.gameData;
            if (levelData.assets) {
                if (mapImageEl && levelData.assets.mapImage) {
                    mapImageEl.src = levelData.assets.mapImage;
                }
                // <-- ¡CORREGIDO! (Lógica de video eliminada de aquí)
                if (headerEl && levelData.assets.bannerHeader) {
                    headerEl.style.backgroundImage = `url('${levelData.assets.bannerHeader}')`;
                }
            }
            console.log(`Nivel ${levelData.levelName} cargado con ${activePath.length} casillas.`);
        }

        // --- ¡EL RESTO DE TUS FUNCIONES ORIGINALES ESTÁN PERFECTAS! ---
        // (Copiar/Pegar el resto de tus funciones aquí, sin cambios,
        // excepto el 'registrationForm' listener más abajo)

        async function checkCedulaOnBlur() {
            const cedula = playerCedulaInput.value.trim();
            if (cedula.length < 5) {
                existingPlayerData = null;
                return;
            }
            console.log(`Buscando cédula: ${cedula}...`);
            try {
                const query = db.collection("registros")
                    .where("cedula", "==", cedula)
                    .limit(1);
                const querySnapshot = await query.get();
                if (!querySnapshot.empty) {
                    console.log("¡Jugador encontrado en la base de datos!");
                    const data = querySnapshot.docs[0].data();
                    existingPlayerData = data;
                    document.getElementById('playerName').value = data.nombre || '';
                    document.getElementById('playerEmail').value = data.email || '';
                    document.getElementById('playerPhone').value = data.telefono || '';
                    document.getElementById('playerAge').value = data.edad || '';
                    document.getElementById('playerGender').value = data.genero || '';
                    document.getElementById('playerCity').value = data.ciudad || '';
                    validateForm();
                } else {
                    console.log("Jugador nuevo, no se encontraron datos.");
                    existingPlayerData = null;
                }
            } catch (error) {
                console.error("Error al buscar la cédula: ", error);
                existingPlayerData = null;
            }
        }

        function showScreen(screenToShow) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); screenToShow.classList.add('active'); }

        function onIntroVideoEnd() {
            if (!gameOver && !hasVideoFinished) {
                hasVideoFinished = true;
                playerPositions = [];
                playerScores = [];
                playerInventories = [];
                playerFichaElements = [];
                playerFichaSrcs = [];
                selectedFichaIdentifiers.clear();
                document.querySelectorAll('.ficha-container.selected').forEach(c => c.classList.remove('selected'));
                mapZoomContainer.querySelectorAll('.player-ficha-class').forEach(ficha => ficha.remove());
                showScreen(mapScreen);

                levelSelectBackdrop.style.display = 'flex';
                setTimeout(() => levelSelectBackdrop.classList.add('visible'), 10);
            }
        }

        function handleLevelSelection(levelDataObject) {
            levelSelectBackdrop.classList.remove('visible');
            setTimeout(() => {
                levelSelectBackdrop.style.display = 'none';
            }, 400);

            loadLevel(levelDataObject);
            startFichaSelection();
        }

        function startFichaSelection() {
            const fullName = playerNames[currentPlayerIndex];
            let playerName;
            if (fullName && fullName.trim() !== '') {
                playerName = fullName.split(' ')[0];
            } else {
                playerName = `Jugador ${currentPlayerIndex + 1}`;
            }
            fichaModalTitle.textContent = `${playerName.toUpperCase()}, elige tu ficha`;
            fichaModalBackdrop.style.display = 'flex';
        }

        function handleFichaSelection(e) {
            const option = e.currentTarget;
            const fichaImgSrc = option.src;
            const fichaIdentifier = option.dataset.ficha;
            const parentContainer = option.closest('.ficha-container');

            if (selectedFichaIdentifiers.has(fichaIdentifier)) {
                console.log("Ficha ya seleccionada, eligiendo otra...");
                return;
            }

            selectedFichaIdentifiers.add(fichaIdentifier);
            parentContainer.classList.add('selected');

            const newFicha = document.createElement('div');
            newFicha.className = 'player-ficha-class';
            newFicha.dataset.player = currentPlayerIndex;
            newFicha.style.backgroundImage = `url('${fichaImgSrc}')`;
            mapZoomContainer.appendChild(newFicha);

            playerFichaElements.push(newFicha);
            playerFichaSrcs.push(fichaImgSrc);
            playerPositions.push(0);
            playerScores.push(0);
            playerInventories.push({ helado: 0, arbol: 0, algodon: 0, poncho: 0, canoa: 0 });

            // --- LÓGICA DE COLOCACIÓN INICIAL (RESTaurada) ---
            const startCoords = activePath[0];
            if (startCoords) {
                newFicha.style.transition = 'none';
                newFicha.style.top = startCoords.top;
                newFicha.style.left = startCoords.left;
                playerPositions[currentPlayerIndex] = 0;
            } else {
                console.error("No se encontraron coordenadas iniciales (posición 0)");
            }
            newFicha.style.display = 'block';
            // --- FIN DE LA CORRECCIÓN ---

            if (playerFichaElements.length === numPlayers) {
                fichaModalBackdrop.style.display = 'none';
                currentPlayerIndex = 0;

               setTimeout(() => {
                    zoomLoaderBackdrop.classList.add('visible');

                    // AÑADE ESTA LÓGICA
                    mapImageEl.onload = () => {
                        // 1. Aplica el zoom
                        const startZone = getZoneForPosition(0);
                        setCameraZone(startZone, true); 
                        mapZoomContainer.classList.add('is-zoomed');
                        isZoomedIn = true;
                        
                        // 2. Espera 2 segundos (el tiempo de la animación de zoom)
                        setTimeout(() => {
                            zoomLoaderBackdrop.classList.remove('visible');
                            gameActive = true;
                            // ... resto de tu lógica de inicio de juego ...
                            if (diceFace) diceFace.classList.add('dice-ready');
                            updateUIForCurrentPlayer();
                        }, 2000); 
                    };
                    
                    // Si la imagen ya está cargada (desde antes), llama al handler directamente
                    if (mapImageEl.complete) {
                        mapImageEl.onload();
                    }
                }, 100);

            } else {
                currentPlayerIndex++;
                const fullName = playerNames[currentPlayerIndex];
                let playerName;
                if (fullName && fullName.trim() !== '') {
                    playerName = fullName.split(' ')[0];
                } else {
                    playerName = `Jugador ${currentPlayerIndex + 1}`;
                }
                fichaModalTitle.textContent = `${playerName.toUpperCase()}, elige tu ficha`;
            }
        }

        function endTurn() {
            currentPlayerIndex = (currentPlayerIndex + 1) % numPlayers;
            if (!gameOver) {
                gameActive = true;
                isRolling = false;
                diceFace.classList.add('dice-ready');
            }
            updateUIForCurrentPlayer();
        }

        function updateUIForCurrentPlayer() {
            if (gameOver) {
                turnIndicator.classList.remove('visible');
                return;
            }
            const listContainer = document.getElementById('player-stats-container');
            if (!listContainer) return;

            // --- LÓGICA ANTIGUA DE 'inventario-activo' ELIMINADA ---
            // Ya no es necesaria, siempre mostramos los 5 slots.

            listContainer.innerHTML = '';
            for (let i = 0; i < numPlayers; i++) {
                const isCurrentTurn = (i === currentPlayerIndex);
                const name = (playerNames[i] ? playerNames[i].split(' ')[0] : `Jugador ${i + 1}`).toUpperCase();
                const score = playerScores[i] || 0;
                const inventory = playerInventories[i];
                const fichaSrc = playerFichaSrcs[i] || 'assets/fichas/ficha_1.png';

                // --- ¡INICIO DE LA NUEVA LÓGICA DE INVENTARIO! ---
                let inventoryHTML = '';

                // Usamos la lista global de recompensas que ya tienes definida
                for (const item of allPossibleRewards) {
                    // Verificamos el conteo para este ítem
                    const count = (inventory && inventory[item]) ? inventory[item] : 0;
                    // Determinamos la clase CSS basada en el conteo
                    const collectedClass = count > 0 ? 'collected' : 'uncollected';

                    // Creamos el HTML para este "slot"
                    inventoryHTML += `
                        <div class="reward-slot ${collectedClass}">
                            <img src="assets/recompensas/${item}.png" alt="${item}" class="reward-slot-icon">
                            <span class="reward-slot-counter">x${count}</span>
                        </div>
                    `;
                }
                // --- ¡FIN DE LA NUEVA LÓGICA DE INVENTARIO! ---

                const row = document.createElement('div');
                row.className = 'player-stat-row';
                if (isCurrentTurn) {
                    row.classList.add('active-turn');
                }
                row.innerHTML = `
                    <img src="${fichaSrc}" alt="Ficha" class="player-ficha-icon">
                    <span class="player-name">${name}</span>
                    <span class="player-score">${score}</span>
                    <div class="player-inventory-small">${inventoryHTML}</div>
                `;
                listContainer.appendChild(row);
            }

            // ... (el resto de tu función sigue igual) ...
            playerFichaElements.forEach((ficha, index) => {
                ficha.classList.toggle('active-turn', index === currentPlayerIndex);
            });
            const currentName = (playerNames[currentPlayerIndex] ? playerNames[currentPlayerIndex].split(' ')[0] : `Jugador ${currentPlayerIndex + 1}`);
            turnIndicatorName.textContent = currentName.toUpperCase();
            if (gameActive && !isRolling) {
                turnIndicator.classList.add('visible');
            } else {
                turnIndicator.classList.remove('visible');
            }

            // Lógica de la cámara (ya la tenías)
            if (isZoomedIn && !gameOver) {
                const currentPlayerPos = playerPositions[currentPlayerIndex];
                const targetZone = getZoneForPosition(currentPlayerPos);
                setCameraZone(targetZone, true);
            }
        }

        function validateForm() { let isFormComplete = true; formInputs.forEach(input => { if (!input.value.trim() || (input.tagName === 'SELECT' && input.value === '')) isFormComplete = false; if (input.type === 'number' && (isNaN(parseInt(input.value)) || parseInt(input.value) <= 0)) isFormComplete = false; }); continueButton.disabled = !isFormComplete; }

        function openInfoModal(data) {
            infoModalTitle.textContent = data.title;
            infoModalDescription.innerHTML = data.description;
            infoModalImage.src = data.image || '';
            infoModalImage.style.display = data.image ? 'block' : 'none';
            // --- REEMPLAZA TU LÓGICA 'infoModalReward' CON ESTO ---
            if (data.rewardId && data.pointsGained > 0) {
                // SÍ hay recompensa
                infoModalRewardIcon.src = `assets/recompensas/${data.rewardId}.png`;
                infoModalRewardIcon.style.display = 'inline-block'; // Muestra el ícono
                infoModalButtonText.textContent = "Reclamar premio"; // Pone el texto
            } else {
                // NO hay recompensa
                infoModalRewardIcon.style.display = 'none'; // Oculta el ícono
                infoModalButtonText.textContent = "Entendido"; // Cambia el texto
            }
            infoModalCloseButton.onclick = () => handleInfoModalClose(data);
            infoModalBackdrop.style.display = 'flex';
            setTimeout(() => infoModalBackdrop.classList.add('visible'), 10);

        }

        function openRewardModal(data) {
            rewardModalTitle.textContent = data.title;
            rewardModalDescription.innerHTML = data.description;

            // --- Lógica del botón actualizado ---
            if (data.rewardId) {
                rewardModalIcon.src = `assets/recompensas/${data.rewardId}.png`;
                rewardModalIcon.style.display = 'inline-block'; // Muestra el ícono
            } else {
                rewardModalIcon.style.display = 'none'; // Oculta si no hay
            }

            // --- Fin de la lógica ---

            rewardModalCloseButton.onclick = () => handleRewardModalClose(data);
            rewardModalBackdrop.style.display = 'flex';
            setTimeout(() => rewardModalBackdrop.classList.add('visible'), 10);
        }
        function openQuestionModal(data) {
            questionText.textContent = data.question;
            questionOptions.innerHTML = '';
            questionFeedback.textContent = '';
            questionContinueButton.style.display = 'none';
            questionModalReward.style.display = 'none';
            data.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.addEventListener('click', () => checkAnswer(index, data), { once: true });
                questionOptions.appendChild(button);
            });
            questionModalBackdrop.style.display = 'flex';
            setTimeout(() => questionModalBackdrop.classList.add('visible'), 10);
        }

        function openEventModal(data) {
            pendingMove = data.move || 0;
            eventText.textContent = data.text;

            // 1. Resetea el estado anterior
            eventModalTitle.classList.remove('advantage', 'trap');
            eventIconContainer.innerHTML = ''; // Limpia el ícono anterior
            eventModalTitle.style.color = ""; // Limpia el color inline

            if (data.type === 'advantage') {
                eventModalTitle.textContent = "¡Ventaja!";
                eventModalTitle.classList.add('advantage');


            } else if (data.type === 'trap') {
                eventModalTitle.textContent = "¡MALA SUERTE!";
                eventModalTitle.classList.add('trap');


            } else {

                eventModalTitle.textContent = "¡Aventura Completada!";
                eventModalTitle.style.color = "#0074D9"; // Un color azul de "éxito"

            }
            eventModalBackdrop.style.display = 'flex';
            setTimeout(() => eventModalBackdrop.classList.add('visible'), 10);
        }


        function openModalForPoint(position) {
            let data;
            let eventType = null;
            const posStr = String(position);

            if (activeGameData.infoPoints[posStr]) { eventType = 'info'; data = activeGameData.infoPoints[posStr]; }
            else if (activeGameData.rewardPoints[posStr]) { eventType = 'reward'; data = activeGameData.rewardPoints[posStr]; }
            else if (activeGameData.questionPoints[posStr]) { eventType = 'question'; data = activeGameData.questionPoints[posStr]; }

            else if (activeGameData.eventPoints[posStr]) {
                data = activeGameData.eventPoints[posStr];
                if (data.type === 'trap' && data.conditionItem) {
                    eventType = 'event_conditional';
                } else {
                    eventType = 'event';
                }
            }
            else if (activeGameData.finalMessage[posStr]) { eventType = 'final'; data = activeGameData.finalMessage[posStr]; }

            if (!data) {
                if (!gameOver) {
                    endTurn();
                }
                return;
            }
            // --- LÓGICA DE AUDIO ACTUALIZADA ---
            // Solo pausamos la música si es un punto de INFORMACIÓN ('info')
            // ya que es donde necesitan usar la cámara/AR.
            if (eventType === 'info' && bgMusic) {
                bgMusic.pause();
            }
            // En los otros casos (reward, question, event), la música seguirá sonando.
            // -----------------------------------
            // ------------------------------------------------------------
            gameActive = false;

            switch (eventType) {
                case 'info': openInfoModal(data); break;
                case 'reward': openRewardModal(data); break;
                case 'question': openQuestionModal(data); break;

                case 'event_conditional':
                    const inventory = playerInventories[currentPlayerIndex];
                    let finalData = { ...data };

                    if (inventory[finalData.conditionItem] > 0) {
                        // ÉXITO (tiene el ítem)
                        if (finalData.itemLost) {
                            inventory[finalData.itemLost]--;
                        }
                        finalData.text = finalData.text_success;

                        // --- ¡ESTE ES EL CAMBIO! ---
                        // Ahora, aunque "tengas éxito", sigue siendo un modal de 'trap' (rojo)
                        finalData.type = 'trap';
                        // --- (Antes decía 'advantage') ---

                        if (finalData.pointsLost_success) {
                            playerScores[currentPlayerIndex] -= finalData.pointsLost_success;
                        }
                        finalData.move = finalData.move_success || 0;

                    } else {
                        // FALLO (no tiene el ítem)
                        if (finalData.pointsLost_fail) {
                            playerScores[currentPlayerIndex] -= finalData.pointsLost_fail;
                        }
                        finalData.text = finalData.text_fail;
                        finalData.type = 'trap'; // Esto ya estaba correcto
                        finalData.move = finalData.move_fail || 0;
                    }
                    updateUIForCurrentPlayer();
                    openEventModal(finalData);
                    break;

                case 'event':
                    if (data.pointsGained) playerScores[currentPlayerIndex] += data.pointsGained;
                    if (data.pointsLost) playerScores[currentPlayerIndex] -= data.pointsLost;
                    if (data.rewardId && playerInventories[currentPlayerIndex].hasOwnProperty(data.rewardId)) {
                        playerInventories[currentPlayerIndex][data.rewardId]++;
                    }

                    if (data.itemLost && playerInventories[currentPlayerIndex].hasOwnProperty(data.itemLost)) {
                        const itemName = data.itemLost.charAt(0).toUpperCase() + data.itemLost.slice(1);
                        if (playerInventories[currentPlayerIndex][data.itemLost] > 0) {
                            playerInventories[currentPlayerIndex][data.itemLost]--;
                            data.text = data.text + ` ¡Pierdes 1 ${itemName}!`;
                        } else {
                            data.text = data.text + ` ... pero no tenías ${itemName} que perder.`;
                        }
                    }

                    updateUIForCurrentPlayer();
                    openEventModal(data);
                    break;

                case 'final': triggerEndGameSequence(); break;
            }
        }

        /**
         * Se llama al hacer clic en el botón de Info Modal.
         * Suma el premio y LUEGO cierra el modal.
         */
        function handleInfoModalClose(data) {
            // 1. ¡AQUÍ SUMAMOS EL PREMIO!
            if (data.pointsGained) {
                playerScores[currentPlayerIndex] += data.pointsGained;
            }
            if (data.rewardId && playerInventories[currentPlayerIndex].hasOwnProperty(data.rewardId)) {
                playerInventories[currentPlayerIndex][data.rewardId]++;
            }

            // 2. Limpiamos el 'onclick' para evitar clics dobles
            infoModalCloseButton.onclick = null;

            // 3. Cerramos el modal (esto llamará a endTurn y actualizará la UI)
            closeModal(infoModalBackdrop);
        }

        /**
         * Se llama al hacer clic en el botón de Reward Modal.
         * Suma el premio y LUEGO cierra el modal.
         */
        function handleRewardModalClose(data) {
            // 1. ¡AQUÍ SUMAMOS EL PREMIO!
            if (data.pointsGained) {
                playerScores[currentPlayerIndex] += data.pointsGained;
            }
            if (data.rewardId && playerInventories[currentPlayerIndex].hasOwnProperty(data.rewardId)) {
                playerInventories[currentPlayerIndex][data.rewardId]++;
            }

            // 2. Limpiamos el 'onclick'
            rewardModalCloseButton.onclick = null;

            // 3. Cerramos el modal (esto llamará a endTurn y actualizará la UI)
            closeModal(rewardModalBackdrop);
        }


        function checkAnswer(selectedIndex, data) {
            const allButtons = questionOptions.querySelectorAll('.option-button');
            const correctIndex = data.correctAnswer;
            allButtons.forEach(button => button.disabled = true);
            if (selectedIndex === correctIndex) {
                allButtons[selectedIndex].classList.add('correct');
                questionFeedback.textContent = data.feedback.correct;
                questionFeedback.style.color = '#2e7d32';
                playerScores[currentPlayerIndex] += data.pointsGained || 0;
                if (data.rewardId && playerInventories[currentPlayerIndex].hasOwnProperty(data.rewardId)) {
                    playerInventories[currentPlayerIndex][data.rewardId]++;
                    questionModalReward.querySelector('.reward-icon').src = `assets/recompensas/${data.rewardId}.png`;
                    questionModalReward.style.display = 'flex';
                }
            } else {
                allButtons[selectedIndex].classList.add('incorrect');
                allButtons[correctIndex].classList.add('correct');
                questionFeedback.textContent = data.feedback.incorrect;
                questionFeedback.style.color = '#c62828';
                playerScores[currentPlayerIndex] -= data.pointsLost || 0;
            }
            questionContinueButton.style.display = 'inline-block';
        }

        function closeModal(backdrop, rewardElement = null) {
            backdrop.classList.remove('visible');
            // --- AGREGA ESTO AQUÍ ---
            // Solo reanudamos si el juego NO ha terminado
            if (bgMusic && !gameOver) {
                bgMusic.play().catch(e => console.log("Error reanudando audio", e));
            }
            // ------------------------

            setTimeout(async () => { // <-- Añadido 'async' aquí

                backdrop.style.display = 'none';
                if (rewardElement) rewardElement.style.display = 'none';


                updateUIForCurrentPlayer();

                if (pendingMove !== 0) {
                    const move = pendingMove;
                    pendingMove = 0; // Resetea el movimiento pendiente


                    await animateMovement(currentPlayerIndex, playerPositions[currentPlayerIndex], move); // <-- Añadido 'await' aquí

                } else if (!gameOver) {

                    endTurn();
                }
            }, 400); // 400ms es el tiempo de la transición de opacidad del modal
        }
        function movePlayerFicha(playerIndex, positionIndex, durationMs = STEP_DURATION_MS) {
            if (positionIndex >= 0 && positionIndex < activePath.length) {
                const fichaElement = playerFichaElements[playerIndex];
                if (!fichaElement) return;
                const newPos = activePath[positionIndex];

                // 1. Desactivamos la transición y establecemos la posición base (top/left)
                fichaElement.style.transition = 'none';
                fichaElement.style.top = newPos.top;
                fichaElement.style.left = newPos.left;

                // 2. Aplicamos la escala INVERSA (0.2) si el mapa está en zoom (modo juego)
                // O scale(1) si no hay zoom (inicio del juego)
                const scaleValue = mapZoomContainer.classList.contains('is-zoomed') ? '0.2' : '1';

                fichaElement.style.transform = `translate(-50%, -50%) scale(${scaleValue})`;
            }
        }

        function moveStepPromise(playerIndex, targetPos) {
            return new Promise(resolve => {
                const fichaElement = playerFichaElements[playerIndex];
                if (!fichaElement || !activePath[targetPos]) {
                    console.warn(`Intento de mover ficha ${playerIndex} a posición inválida ${targetPos}`);
                    resolve();
                    return;
                }

                const newPos = activePath[targetPos];
                const durationSec = STEP_DURATION_MS / 1000;

                // Determina la escala CONSTANTE que la ficha debe mantener durante el juego
                const targetScale = mapZoomContainer.classList.contains('is-zoomed') ? '0.2' : '1';

                const timeoutId = setTimeout(() => {
                    console.warn(`Timeout de TransitionEnd alcanzado para ficha ${playerIndex} moviéndose a ${targetPos}`);
                    fichaElement.removeEventListener('transitionend', onTransitionEnd);
                    resolve();
                }, STEP_DURATION_MS + 150);

                const onTransitionEnd = (event) => {
                    if (event.target === fichaElement && event.propertyName === 'transform') {
                        clearTimeout(timeoutId);
                        fichaElement.removeEventListener('transitionend', onTransitionEnd);

                        // Al finalizar, aseguramos la escala correcta
                        fichaElement.style.transform = `translate(-50%, -50%) scale(${targetScale})`;

                        resolve();
                    }
                };

                // 1. Establece la posición estática (top/left) SIN TRANSICIÓN
                fichaElement.style.transition = 'none';
                fichaElement.style.top = newPos.top;
                fichaElement.style.left = newPos.left;

                // 2. Prepara la transición SÓLO para 'transform'
                requestAnimationFrame(() => {
                    fichaElement.addEventListener('transitionend', onTransitionEnd);
                    fichaElement.style.transition = `transform ${durationSec}s linear, box-shadow 0.3s ease`;

                    // 3. APLICA LA ESCALA CORRECTA (targetScale) Y EL TRANSLATE para iniciar la animación
                    fichaElement.style.transform = `translate(-50%, -50%) scale(${targetScale})`;
                });

                playerPositions[playerIndex] = targetPos;
            });
        }
        async function animateMovement(playerIndex, startPos, steps) {
            if (steps === 0) {
                if (!gameOver) endTurn();
                return;
            }
            const direction = Math.sign(steps);
            const totalSteps = Math.abs(steps);
            let stopFound = false;
            let stopIndex = -1;

            // 1. Analizar paradas (sin cambios)
            for (let i = 1; i <= totalSteps; i++) {
                const checkPos = startPos + (i * direction);
                if (checkPos < 0 || checkPos >= activePath.length) break;
                if (activeGameData && activeGameData.infoPoints && activeGameData.infoPoints[String(checkPos)]) {
                    stopIndex = i;
                    stopFound = true;
                    break;
                }
            }
            const stepsToAnimate = stopFound ? stopIndex : totalSteps;
            let finalPositionAfterAnim = startPos + (stepsToAnimate * direction);

            // 2. Ajuste de límites (sin cambios)
            if (finalPositionAfterAnim >= activePath.length) {
                finalPositionAfterAnim = activePath.length - 1;
            } else if (finalPositionAfterAnim < 0) {
                finalPositionAfterAnim = 0;
            }

            // --- ¡NUEVA LÓGICA DE CÁMARA! ---
            // 3. Decide la zona de destino ANTES de moverte.
            if (isZoomedIn) {
                const targetZone = getZoneForPosition(finalPositionAfterAnim);
                setCameraZone(targetZone, true); // true = animar
            }
            // --- FIN DE LA NUEVA LÓGICA ---

            // 4. Bucle de animación (¡SIN CÁMARA DENTRO!)
            for (let i = 1; i <= stepsToAnimate; i++) {
                let currentStepTargetPosition = startPos + (i * direction);
                if (currentStepTargetPosition >= activePath.length) {
                    currentStepTargetPosition = activePath.length - 1;
                } else if (currentStepTargetPosition < 0) {
                    currentStepTargetPosition = 0;
                }

                // ¡YA NO SE ACTUALIZA LA CÁMARA AQUÍ!
                await moveStepPromise(playerIndex, currentStepTargetPosition);

                if (currentStepTargetPosition === activePath.length - 1 || currentStepTargetPosition === 0) {
                    break;
                }
            }

            // 5. Acción final (sin cambios)
            if (stopFound) {
                pendingMove = (totalSteps - stepsToAnimate) * direction;
            }

            const modalDelay = 1000;
            setTimeout(() => {
                openModalForPoint(finalPositionAfterAnim);
            }, modalDelay);
        }


        function rollDice() {
    if (!gameActive || isRolling || gameOver) return;

    // Inicia el sonido del dado
    if (diceSound) {
        diceSound.currentTime = 0;
        diceSound.play().catch(e => console.log("Error audio dado", e));
    }

    isRolling = true;
    gameActive = false;
    turnIndicator.classList.remove('visible');
    diceFace.classList.remove('dice-ready');

    // Inicia animación de giro (solo la rotación 3D)
    diceCube.className = 'dice-cube';
    // DICE-CONTAINER.classList.remove/add('is-launching') ELIMINADO
    diceCube.classList.add('is-rolling');

    const rollResult = Math.floor(Math.random() * 6) + 1;

    // 1. Termina el giro (1000ms)
    setTimeout(() => {
        diceCube.classList.remove('is-rolling');
        diceCube.classList.add(`show-${rollResult}`);

        // 2. Espera y mueve la ficha (500ms)
        setTimeout(() => {
            // diceContainer.classList.remove('is-launching'); <--- ELIMINADO
            const startPos = playerPositions[currentPlayerIndex];
            animateMovement(currentPlayerIndex, startPos, rollResult);
        }, 500);

    }, 1000);
}
        // --- AÑADE O REEMPLAZA ESTA FUNCIÓN ---
        function onFinalVideoEnd() {
            // 1. Limpiamos el listener del video
            localVideoPlayer.removeEventListener('ended', onFinalVideoEnd);

            // 2. Preparamos los datos de puntuación
            let maxScore = -Infinity;
            let scoresData = []; // Un array para guardar {name, score}

            for (let i = 0; i < numPlayers; i++) {
                const score = playerScores[i];
                const name = (playerNames[i] ? playerNames[i].split(' ')[0] : `Jugador ${i + 1}`).toUpperCase();

                scoresData.push({ name: name, score: score });

                if (score > maxScore) {
                    maxScore = score;
                }
            }

            // 3. Ordenamos por puntaje, de mayor a menor
            scoresData.sort((a, b) => b.score - a.score);

            // 4. Construimos el HTML para los detalles del puntaje
            let detailsHTML = '<h4>Resultados Finales:</h4>';

            scoresData.forEach((data, index) => {
                const isWinner = data.score === maxScore;
                detailsHTML += `
            <div class="score-entry ${isWinner ? 'winner' : ''}">
                <span class="score-entry-name">${index + 1}. ${data.name}</span>
                <span class="score-entry-score">${data.score} puntos</span>
            </div>
        `;
            });

            // 5. Poblamos el modal
            finalScoreDetails.innerHTML = detailsHTML;
            playAgainButton.onclick = () => location.reload();

            // 6. Mostramos el modal final (sobre la pantalla de video en negro)
            finalScoreBackdrop.style.display = 'flex';
            setTimeout(() => finalScoreBackdrop.classList.add('visible'), 10);
        }
        // --- REEMPLAZA ESTA FUNCIÓN ---
        function triggerEndGameSequence() {
            gameOver = true;
            gameActive = false;
            isRolling = false;
            updateUIForCurrentPlayer(); // Oculta el indicador de turno
            diceContainer.style.display = 'none'; // Oculta el dado

            // 1. Prepara el overlay de confeti
            gameOverText.textContent = `¡Has completado la ruta!`;
            gameOverBackdrop.style.display = 'flex';
            setTimeout(() => {
                gameOverBackdrop.classList.add('visible');
            }, 10);

            // 2. Espera 4 segundos
            setTimeout(() => {
                // 3. Oculta el confeti
                gameOverBackdrop.classList.remove('visible');
                setTimeout(() => {
                    gameOverBackdrop.style.display = 'none';
                    // --- AQUÍ INSERTAMOS LA PAUSA DE LA MÚSICA ---
                    if (bgMusic) {
                        bgMusic.pause();
                        bgMusic.currentTime = 0; // Reinicia para la próxima vez que se inicie el juego
                    }
                    // ----------------------------------------------

                    // 4. MUESTRA EL VIDEO y AÑADE EL LISTENER
                    showScreen(videoScreen);
                    localVideoPlayer.removeEventListener('ended', onIntroVideoEnd);

                    // ¡ESTA LÍNEA ES LA CONEXIÓN QUE FALTA!
                    localVideoPlayer.addEventListener('ended', onFinalVideoEnd);
                    // --- ¡ESTAS SON LAS LÍNEAS NUEVAS! ---
                    // 1. Busca el elemento <source> dentro de tu video player
                    const videoSource = localVideoPlayer.querySelector('source');

                    // 2. CAMBIA ESTA RUTA por la de tu video final
                    videoSource.src = 'assets/video/final_juego.mp4';

                    // 3. Dile al player que cargue el nuevo video
                    localVideoPlayer.load();
                    // --- FIN DE LAS LÍNEAS NUEVAS ---
                    localVideoPlayer.currentTime = 0;
                    localVideoPlayer.muted = false;
                    localVideoPlayer.play();

                }, 1000); // Espera a que termine la animación de fade-out

            }, 4000); // Duración del confeti en pantalla
        }

        function setupGame(playerCount) {
            numPlayers = playerCount;
            currentPlayerIndex = 0;
            playerSelectBackdrop.classList.remove('visible');
            setTimeout(() => {
                playerSelectBackdrop.style.display = 'none';
            }, 400);
            registrationModalTitle.textContent = `Registro de Jugador ${currentPlayerIndex + 1}`;
            validateForm();
        }

        // ===========================================
        // 6. EVENT LISTENERS (¡CORREGIDOS!)
        // ===========================================

        btn1Player.addEventListener('click', () => setupGame(1));
        btn2Players.addEventListener('click', () => setupGame(2));
        btn3Players.addEventListener('click', () => setupGame(3));

        registrationForm.addEventListener('input', validateForm);

        // --- LISTENER DEL FORMULARIO (¡CORREGIDO!) ---
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = registrationForm.querySelector('button[type="submit"]');
            const formData = new FormData(registrationForm);
            const playerData = {
                cedula: formData.get('playerCedula'),
                nombre: formData.get('playerName'),
                email: formData.get('playerEmail'),
                telefono: formData.get('playerPhone'),
                edad: formData.get('playerAge') ? parseInt(formData.get('playerAge')) : null,
                genero: formData.get('playerGender'),
                ciudad: formData.get('playerCity'),
            };
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            try {
                if (existingPlayerData) {
                    console.log(`Usando datos existentes para el jugador ${currentPlayerIndex + 1} (Cédula: ${existingPlayerData.cedula})`);
                } else {
                    console.log(`Registrando nuevo jugador ${currentPlayerIndex + 1}`);
                    playerData.registradoEn = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await db.collection("registros").add(playerData);
                    console.log(`Jugador nuevo registrado con ID: ${docRef.id}`);
                }
                const nombreParaGuardar = existingPlayerData ? existingPlayerData.nombre : playerData.nombre;
                playerNames.push(nombreParaGuardar);
                currentPlayerIndex++;
                if (currentPlayerIndex < numPlayers) {
                    registrationModalTitle.textContent = `Registro de Jugador ${currentPlayerIndex + 1}`;
                    registrationForm.reset();
                    existingPlayerData = null;
                    validateForm();
                    submitButton.innerHTML = '<i class="fas fa-gamepad"></i> Registrar jugador';
                } else {
                    modalBackdrop.style.display = 'none';
                    showScreen(videoScreen);

                    // --- ¡CORREGIDO! (Política de Autoplay) ---
                    // Forzamos el 'muted = true' para que el navegador PERMITA la reproducción.
                    // El usuario puede quitar el silencio con los 'controls'.
                    localVideoPlayer.muted = false;

                    localVideoPlayer.play().catch(error => { console.warn("Autoplay prevenido.", error); });

                    registrationForm.reset();
                    existingPlayerData = null;
                    validateForm();
                    submitButton.innerHTML = '<i class="fas fa-gamepad"></i> Registrar jugador';
                    currentPlayerIndex = 0;
                }
            } catch (error) {
                console.error("Error al procesar el registro: ", error);
                alert("Hubo un error al procesar el registro. Por favor, inténtalo de nuevo.");
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-gamepad"></i> Registrar jugador';
            }
        });

        fichaOptions.forEach(option => {
            option.addEventListener('click', handleFichaSelection);
        });

        playerCedulaInput.addEventListener('blur', checkCedulaOnBlur);


        questionContinueButton.addEventListener('click', () => closeModal(questionModalBackdrop, questionModalReward));
        eventModalCloseButton.addEventListener('click', () => closeModal(eventModalBackdrop));
        diceFace.addEventListener('click', rollDice);

        document.addEventListener('DOMContentLoaded', () => {
            modalBackdrop.style.display = 'flex';
            playerSelectBackdrop.style.display = 'flex';
            setTimeout(() => playerSelectBackdrop.classList.add('visible'), 10);
            localVideoPlayer.addEventListener('ended', onIntroVideoEnd);

            btnLevel1.addEventListener('click', () => {
                handleLevelSelection(LEVEL_1_DATA);
            });
            btnLevel2.addEventListener('click', () => alert("Nivel 2 - ¡Próximamente!"));
            btnLevel3.addEventListener('click', () => alert("Nivel 3 - ¡Próximamente!"));
            btnLevel4.addEventListener('click', () => alert("Nivel 4 - ¡Próximamente!"));
        });

        document.addEventListener("DOMContentLoaded", function () {
            const nombreInput = document.getElementById("playerName");
            const ciudadInput = document.getElementById("playerCity");
            function forzarMayusculas() {
                this.value = this.value.toUpperCase();
            }
            nombreInput.addEventListener("input", forzarMayusculas);
            ciudadInput.addEventListener("input", forzarMayusculas);
        });



        // --- ¡NUEVO! FUNCIONES DE CÁMARA ---

        /**
         * Decide si una casilla pertenece a la zona 'arriba' o 'abajo'
         */
        function getZoneForPosition(positionIndex) {
            if (positionIndex <= 28) {
                return 'abajo';
            } else if (positionIndex <= 36) {
                return 'media';
            } else {
                return 'arriba';
            }
        }

        /**
         * Mueve la cámara a una zona específica, con o sin animación.
         */
        function setCameraZone(newZone, animate = true) {

            if (newZone === currentCameraZone) {
                return; // Ya estamos en esta zona
            }
            console.log(`Cambiando cámara a la zona: ${newZone}`);
            currentCameraZone = newZone;

            const zoneData = CAMERA_ZONES[newZone];

            // Comprobamos si el mapa YA ESTÁ en modo zoom
            const isAlreadyZoomed = mapZoomContainer.classList.contains('is-zoomed');

            if (animate) {
                if (isAlreadyZoomed) {
                    // --- ESCENARIO 1: YA ESTAMOS "DENTRO" DEL JUEGO ---
                    // (Moviéndonos de 'abajo' a 'media')
                    // Aquí SÍ queremos animar el pivote (transform-origin)
                    mapZoomContainer.style.transition = 'transform 2s ease-in-out, transform-origin 2s ease-in-out';
                    mapZoomContainer.style.transformOrigin = zoneData.origin;
                    mapZoomContainer.style.transform = zoneData.transform;

                } else {
                    // --- ESCENARIO 2: ES EL ZOOM INICIAL ---
                    // (Moviéndonos de 'lejos' a 'abajo')
                    // Aquí usamos la técnica "anti-deslizamiento"
                    mapZoomContainer.style.transition = 'none';
                    mapZoomContainer.style.transformOrigin = zoneData.origin;
                    void mapZoomContainer.offsetHeight; // Forzar reflow
                    mapZoomContainer.style.transition = 'transform 2s ease-in-out';
                    mapZoomContainer.style.transform = zoneData.transform;
                }

            } else {
                // Lógica para movimiento no-animado (está bien como estaba)

                mapZoomContainer.style.transition = 'none';
                mapZoomContainer.style.transformOrigin = zoneData.origin;
                mapZoomContainer.style.transform = zoneData.transform;

            }
        }

    </script>
</body>

</html>
</body>

</html>
